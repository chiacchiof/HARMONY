{"version":3,"file":"static/js/699.877174a8.chunk.js","mappings":"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","sources":["services/matlab-execution-service.ts"],"sourcesContent":["/**\r\n * Service for executing MATLAB commands via backend API\r\n * This handles the real MATLAB execution using Node.js child_process\r\n */\r\n\r\nexport interface MatlabExecutionRequest {\r\n  shyftaPath: string;\r\n  modelName: string;\r\n  modelContent: string;\r\n  zftaContent: string;\r\n  isCTMC?: boolean; // Flag to indicate CTMC execution vs SHyFTA\r\n}\r\n\r\nexport interface MatlabExecutionResponse {\r\n  success: boolean;\r\n  output?: string;\r\n  error?: string;\r\n  progress?: number;\r\n  exitCode?: number;\r\n  resultsPath?: string;\r\n}\r\n\r\nexport class MatlabExecutionService {\r\n  private static readonly API_BASE_URL = `http://${window.location.hostname}:3001/api`; // Backend server\r\n\r\n  /**\r\n   * Execute MATLAB simulation via backend API\r\n   */\r\n  static async executeMatlabSimulation(request: MatlabExecutionRequest): Promise<void> {\r\n    try {\r\n      console.log('üöÄ Sending MATLAB execution request to backend...');\r\n      \r\n      const response = await fetch(`${this.API_BASE_URL}/matlab/execute`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(request)\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Backend API error: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const result: MatlabExecutionResponse = await response.json();\r\n      \r\n      if (!result.success) {\r\n        throw new Error(result.error || 'MATLAB execution failed');\r\n      }\r\n\r\n      console.log('‚úÖ MATLAB execution completed successfully');\r\n      console.log('üìä Output:', result.output);\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Failed to execute MATLAB:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start MATLAB simulation with real-time progress monitoring\r\n   */\r\n  static async startMatlabWithMonitoring(\r\n    request: MatlabExecutionRequest,\r\n    onProgress: (progress: number, output: string) => void\r\n  ): Promise<void> {\r\n    try {\r\n      console.log('üîß Starting MATLAB with real-time monitoring...');\r\n\r\n      // Create abort controller for manual stop functionality only\r\n      const abortController = new AbortController();\r\n      // No automatic timeout - users can stop manually via UI button\r\n      \r\n      // Use fetch with streaming for POST request with file content\r\n      const response = await fetch(`${this.API_BASE_URL}/matlab/execute-stream`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Accept': 'text/event-stream',\r\n        },\r\n        body: JSON.stringify(request),\r\n        signal: abortController.signal\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Backend API error: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) {\r\n        throw new Error('Failed to get response stream reader');\r\n      }\r\n\r\n      return new Promise(async (resolve, reject) => {\r\n        const decoder = new TextDecoder();\r\n        let buffer = '';\r\n\r\n        try {\r\n          while (true) {\r\n            const { done, value } = await reader.read();\r\n            \r\n            if (done) {\r\n              console.log('üì° Stream ended');\r\n              break;\r\n            }\r\n\r\n            // Decode the chunk and add to buffer\r\n            buffer += decoder.decode(value, { stream: true });\r\n            \r\n            // Process complete lines\r\n            const lines = buffer.split('\\n');\r\n            buffer = lines.pop() || ''; // Keep incomplete line in buffer\r\n\r\n            for (const line of lines) {\r\n              if (line.startsWith('data: ')) {\r\n                try {\r\n                  const dataStr = line.substring(6); // Remove 'data: ' prefix\r\n                  if (dataStr.trim()) {\r\n                    const data: MatlabExecutionResponse = JSON.parse(dataStr);\r\n                    \r\n                    console.log('üì° Real-time update:', data);\r\n                    \r\n                    if (data.progress !== undefined) {\r\n                      onProgress(data.progress, data.output || '');\r\n                    }\r\n\r\n                    if (data.success) {\r\n                      console.log('üéâ MATLAB simulation completed!');\r\n                      reader.releaseLock();\r\n                      resolve();\r\n                      return;\r\n                    }\r\n                    \r\n                    // Check for simulation failure with exit code\r\n                    if (data.hasOwnProperty('exitCode') && data.exitCode !== 0) {\r\n                      console.error('‚ùå MATLAB simulation failed with exit code:', data.exitCode);\r\n                      reader.releaseLock();\r\n                      reject(new Error(`MATLAB simulation failed (exit code: ${data.exitCode})`));\r\n                      return;\r\n                    }\r\n\r\n                    // Report errors immediately but don't stop streaming\r\n                    if (data.error && data.progress !== undefined) {\r\n                      console.error('‚ùå MATLAB execution error:', data.error);\r\n                      onProgress(data.progress, `‚ùå ERRORE: ${data.error}\\n${data.output || ''}`);\r\n                    }\r\n                    \r\n                    // Only reject on final error without progress\r\n                    if (data.error && data.progress === undefined) {\r\n                      console.error('‚ùå MATLAB execution error:', data.error);\r\n                      reader.releaseLock();\r\n                      reject(new Error(data.error));\r\n                      return;\r\n                    }\r\n                  }\r\n                } catch (parseError) {\r\n                  console.error('Failed to parse SSE data:', parseError, 'Line:', line);\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          reader.releaseLock();\r\n          resolve();\r\n\r\n        } catch (streamError) {\r\n          console.error('‚ùå Stream reading error:', streamError);\r\n          reader.releaseLock();\r\n          \r\n          // Provide more specific error messages for common issues\r\n          if (streamError instanceof Error) {\r\n            if (streamError.name === 'AbortError') {\r\n              reject(new Error('L\\'analisi √® stata interrotta dall\\'utente'));\r\n            } else if (streamError.message && streamError.message.includes('BodyStreamBuffer')) {\r\n              reject(new Error('Errore di connessione durante l\\'analisi CTMC. Riprova.'));\r\n            } else {\r\n              reject(streamError);\r\n            }\r\n          } else {\r\n            reject(new Error('Errore sconosciuto durante l\\'analisi CTMC'));\r\n          }\r\n        }\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Failed to start MATLAB monitoring:', error);\r\n      \r\n      // Provide user-friendly error messages\r\n      if (error instanceof Error) {\r\n        if (error.name === 'AbortError') {\r\n          throw new Error('L\\'analisi √® stata interrotta dall\\'utente');\r\n        } else if (error.message.includes('BodyStreamBuffer')) {\r\n          throw new Error('Errore di connessione durante l\\'analisi CTMC. Verifica che il backend sia attivo e riprova.');\r\n        } else if (error.message.includes('fetch')) {\r\n          throw new Error('Impossibile connettersi al backend MATLAB. Verifica che il server sia attivo sulla porta 3001.');\r\n        }\r\n      }\r\n      \r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if backend API is available\r\n   */\r\n  static async checkBackendAvailability(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${this.API_BASE_URL}/health`, {\r\n        method: 'GET',\r\n        signal: AbortSignal.timeout(10000) // 10 second timeout\r\n      });\r\n      return response.ok;\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Backend API not available:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop running MATLAB simulation via backend API\r\n   */\r\n  static async stopMatlabSimulation(): Promise<boolean> {\r\n    try {\r\n      console.log('üõë Requesting MATLAB simulation stop...');\r\n      \r\n      const response = await fetch(`${this.API_BASE_URL}/matlab/stop`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Backend API error: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      \r\n      if (result.success) {\r\n        console.log('‚úÖ MATLAB simulation stop requested successfully');\r\n        console.log('üìù Message:', result.message);\r\n        return true;\r\n      } else {\r\n        console.error('‚ùå Failed to stop MATLAB simulation:', result.error);\r\n        return false;\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Failed to stop MATLAB simulation:', error);\r\n      return false;\r\n    }\r\n  }\r\n}"],"names":["MatlabExecutionService","executeMatlabSimulation","request","console","log","response","fetch","concat","this","API_BASE_URL","method","headers","body","JSON","stringify","ok","Error","status","statusText","result","json","success","error","output","startMatlabWithMonitoring","onProgress","_response$body","abortController","AbortController","signal","reader","getReader","Promise","async","resolve","reject","decoder","TextDecoder","buffer","done","value","read","decode","stream","lines","split","pop","line","startsWith","dataStr","substring","trim","data","parse","undefined","progress","releaseLock","hasOwnProperty","exitCode","parseError","streamError","name","message","includes","checkBackendAvailability","AbortSignal","timeout","warn","stopMatlabSimulation","window","location","hostname"],"sourceRoot":""}